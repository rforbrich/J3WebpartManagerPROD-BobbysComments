/** 
 * index.min.js
 * @description This is the bare bones version of the webpart manager,
 * this only calls the Bootstrap CSS, jQuery & Bootstrap JavaScript is removed.
 * @author Wilfredo Pacheco
 */

import CreateList from "./Factory.min.js";
import Route, { SiteCollectionUrl } from "./Route.js";
import WEBPARTS from "./Webparts.List.js";

export async function InstallList(event){

    const isPointerEvent = event?.constructor?.name === 'PointerEvent';
    let Element, OriginalHTML;

    if (isPointerEvent)
    {
        Element = event.target.tagName === 'BUTTON' ? 
        event.target : 
        event.target.closest('button');

        OriginalHTML = Element.innerHTML;

        /** Disable button; */
        Element.setAttribute('disabled', '');
        Element.innerHTML = /*html*/`
        <span class="spinner-border spinner-border-sm" 
            role="status" 
            aria-hidden="true">
        </span> Loading...`;
    }
    
    const { schema } = this.getWebpart();
    const Web = this.Web;
    const Callback = this.callback;
    const List = await Route.Get(`${Web.Url}/_api/Web/Lists/getByTitle('${schema.list.Title}')`);
    if (List)
    {
        alert('This list has already been created!');
        if (isPointerEvent) $(Element).html(OriginalHTML)
        .removeAttr('disabled');
    }
    else
    {
        const ReqDigest = await Route.GetRequestDigest();
        const NewList = await CreateList({
            Route, 
            Web,
        },{ 
            AddViewFieldTitle: false,
            AddViewFieldGUID: false,
            List: schema.list,
            Fields: schema.fields,
            PredefinedData: null, 
        }, Callback);

        /** Clean up the Title field, change Title required to false; */
        return Route.Patch(`${NewList.__metadata.uri}/Fields/getByTitle('Title')`,{
            Required: false,
            __metadata: {
                type: 'SP.FieldText'
            }
        }, ReqDigest)
        .then(data => location.reload());
    }
}

export async function RemoveList(event){

    const isPointerEvent = event?.constructor?.name === 'PointerEvent';
    let Element, OriginalHTML;

    if (isPointerEvent)
    {
        Element = event.target.tagName === 'BUTTON' ? 
        event.target : 
        event.target.closest('button');

        OriginalHTML = Element.innerHTML;

        /** Disable button; */
        Element.setAttribute('disabled', '');
        Element.innerHTML = /*html*/`
        <span class="spinner-border spinner-border-sm" 
            role="status" 
            aria-hidden="true">
        </span> Loading...`;
    }

    const { schema } = this.getWebpart();
    const Web = this.Web;
    const List = await Route.Get(`${Web.Url}/_api/Web/Lists/getByTitle('${schema.list.Title}')`);
    const ReqDigest = await Route.GetRequestDigest();
    if (!List)
    {
        alert('This list has not been created!');
        if (isPointerEvent)
        {
            Element.innerHTML = OriginalHTML;
            Element.removeAttribute('disabled');
        }
    }
    else return Route.Delete(List.__metadata.uri, ReqDigest)
    .then(data => location.reload());
}

const xIcon = /*svg*/`
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle-fill text-danger" viewBox="0 0 16 16">
    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
</svg>`;

const checkIcon = /*svg*/`
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill text-success" viewBox="0 0 16 16">
    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
</svg>`;

(function(){

    const Container = document.createElement('div');
    const DisplayElement = document.createElement('div');
    const favicon = document.createElement('link');
    favicon.setAttribute('rel', 'shortcut icon');
    favicon.setAttribute('href', '/_layouts/15/images/favicon.ico?rev=23');
    favicon.setAttribute('type', 'image/vnd.microsoft.icon');
    favicon.setAttribute('id', 'favicon');

    /** DOMContentLoaded Event; */
    document.addEventListener('DOMContentLoaded', function RenderContent(event){
        document.head.append(favicon);
        document.title = 'Webpart Manager';
        document.body.classList.add('container');
        document.body.append(Container);
        // $(document.body).append(`<img src="_layouts/15/images/siteIcon.png?rev=40" />`);
        Container.classList = 'card-body col-xl-6 col-lg-8 col-md-10 col-sm-11 shadow-lg';
        Container.setAttribute('style', 'border-radius: 1.25rem!important; position: absolute!important;top: 40%;left: 50%;transform: translate(-50%, -50%);background-color: #eeeeff !important;');
        Container.innerHTML = /*html*/`<!-- Form Container Content -->
        <div class="p-4 text-center">
            <h1>${document.title}</h1>
        </div>
        <div id="settings-panel"></div>
        <table class="table table-sm table-hover">
            <thead>
                <tr>
                    <th>Title</th>
                    <th class="text-center">Installed</th>
                    <th class="">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>`
    });
    
    /** window.onload Event; */
    async function init(){

        const SettingsPanel = Container.querySelector('div#settings-panel');
        const TableBody = Container.querySelector('table tbody');

        /** Call to get the Microsoft SharePoint Web Object; */
        const Web = await Route.init(`${SiteCollectionUrl}/_api/Web`, {
            $select: '*',
            $expand: 'Lists,RegionalSettings,CurrentUser,Folders',
        });

        SettingsPanel.classList = 'text-right';
        SettingsPanel.innerHTML = /*html*/`
        <a class="m-1" href="${Web.Url}" target="_blank">Home</a>
        <a class="m-1" href="${Web.Url}/_layouts/15/viewlsts.aspx" target="_blank">Site Contents</a>
        <a class="m-1" href="${Web.Url}/_layouts/15/Settings.aspx" target="_blank">Settings</a>`;

        WEBPARTS.forEach(wp => {

            const IconContainer = document.createElement('span');
            const isFound = Web.getListDetails(wp.schema.list.Title);
            IconContainer.innerHTML = !!isFound ?
            checkIcon : 
            xIcon;

            const {title, id} = wp;
            const tr = document.createElement('tr');
            tr.innerHTML = /*html*/`
            <td>${title}</td>
            <td class="text-center">${IconContainer.outerHTML}</td>
            <td class="">
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button type="button" id="install-${id}" class="btn btn-outline-secondary btn-sm">Install</button>
                    <button type="button" id="remove-${id}" class="btn btn-outline-secondary btn-sm">Remove</button>
                    <a id="link-${id}" href="${
                        !!isFound ? 
                        `${Web.Url}/Lists/${wp.schema.list.Title}/AllItems.aspx` :
                        `javascript:alert('The list ${wp.schema.list.Title} has not been created, please click the install button to create the list.');`
                    }" class="btn btn-outline-secondary btn-sm" ${
                        !!isFound ? 
                        `target="_blank"` :
                        ''
                    } >
                        <img style="width: 16px;" src="/_layouts/15/images/favicon.ico?rev=23" /> Visit List
                    </a>
                </div>
            </td>`;

            const InstallButton = tr.querySelector(`button#install-${id}`);
            const RemoveButton = tr.querySelector(`button#remove-${id}`);
            InstallButton.addEventListener('click', InstallList);
            RemoveButton.addEventListener('click', RemoveList);

            Object.assign(InstallButton, {
                Route,
                Web,
                getWebpart(){
                    return wp;
                },
                callback(message){
                    const div = document.createElement('div');
                    div.classList = 'text-primary';
                    div.setAttribute('style', 'font-size: 12px;');
                    div.innerText = message;
                    DisplayElement.append(div);
                    document.documentElement.scrollTop = document.body.scrollTop = document.body.scrollHeight;
                }
            });

            Object.assign(RemoveButton, {
                Route,
                Web,
                getWebpart(){
                    return wp;
                },
            });

            TableBody.append(tr);
        });

        Container.append(DisplayElement);
    }
    
    window.onload = init;
})();